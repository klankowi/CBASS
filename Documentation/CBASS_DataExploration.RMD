---
title: "CBASS Data Cleaning and Exploration"
author: "Katie Lankowicz"
date: "2023-06-13"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      message = FALSE,
                      warning= FALSE)
```

```{r libraries}
# Clear workspace
rm(list=ls())

# Load packages
library(reprex, quietly=T, verbose=F)
suppressPackageStartupMessages(library(tidyverse, quietly=T, verbose=F))
suppressPackageStartupMessages(library(readxl, quietly=T, verbose=F))
suppressPackageStartupMessages(library(here, quietly=T, verbose=F))
suppressPackageStartupMessages(library(padr, quietly=T, verbose=F))
suppressPackageStartupMessages(library(zoo, quietly=T, verbose=F))
suppressPackageStartupMessages(library(sf, quietly=T, verbose=F))
suppressPackageStartupMessages(library(vegan, quietly=T, verbose=F))
suppressPackageStartupMessages(library(kableExtra, quietly=T, verbose=F))
suppressPackageStartupMessages(library(reshape2, quietly=T, verbose=F))
suppressPackageStartupMessages(library(ggsflabel, quietly=T, verbose=F))
suppressPackageStartupMessages(library(cowplot, quietly=T, verbose=F))
suppressPackageStartupMessages(library(smplot2, quietly=T, verbose=F))

# Negate function
'%notin%' <- function(x,y)!('%in%'(x,y))

# Set GGplot auto theme
theme_set(theme(panel.grid.major = element_line(color='lightgray'),
                panel.grid.minor = element_blank(),
                panel.background = element_blank(),
                panel.border = element_rect(color='black', linewidth=1, fill=NA),
                legend.position = "bottom",
                axis.text.x=element_text(size=12),
                axis.text.y=element_text(size=12),
                axis.title.x=element_text(size=14),
                axis.title.y=element_text(size=14, angle=90, vjust=2),
                plot.title=element_text(size=14, hjust = 0, vjust = 1.2),
                plot.caption=element_text(hjust=0, face='italic', size=12),
                strip.text.x=element_text(size=12)))
```

## Casco Bay Aquatic Systems Survey
The CBASS project has been ongoing since 2014, with a seine component in the greater Portland region of Casco Bay every year. The purpose of this document is to do some basic data exploration.

```{r load, echo=F}
# Set the name of the workbook
fname <- paste0(here('Clean_Data/seine_compiled_clean.xlsx'))
# Get info about all excel sheet names in workbook
sheets <- readxl::excel_sheets(fname)
# Read in as list item, each item is a sheet
data.all <- invisible(lapply(sheets, 
                           function(x) readxl::read_excel(fname, sheet = x)))
names(data.all) <- c('sites', 'species', 'trips', 'fish', 'abundance')
# Coerce list items to dataframes
data.all <- lapply(data.all, as.data.frame)

rm(fname, sheets)
```

## Site information
The `sites` tab includes site name and geospatial location information (lat-lon, UTM northing-easting) for each sampling location. There are 12 sites in the greater Portland area of the survey. These are grouped into levels of a category called "bay location" based on proximity to open ocean- "Inner Bay" being within the Presumpscot River region, "Mid-Bay" being north of Portland peninsula, and "Outer Bay" being closest to open ocean. 

```{r portland-siteplots, message=F, warning=F, fig.width= 7.5, fig.height=8}
data.all$sites <- dplyr::select(data.all$sites,
                                site_name, latitude, longitude, bay_location)
data.all.goodcoords <- data.all$sites[complete.cases(data.all$sites),]
# Convert to sf (spatial features) object
sites.sf <- st_as_sf(data.all.goodcoords, coords=c('longitude', 'latitude'))
sites.sf <- sites.sf[sites.sf$site_name != "The Brothers - South",]
# Set CRS (coordinate reference system)
st_crs(sites.sf) <- "EPSG:4326"
colnames(sites.sf) <- c('Site name', 'Bay location', 'geometry')
# Call coastline shapefile
coast <- st_read(here("GIS/us_medium_shoreline_poly.shp"), quiet=T)
coast <- st_transform(coast, st_crs(sites.sf))

esites.sf <- sites.sf[sites.sf$`Bay location` == 'north',]
esites.sf <- esites.sf[esites.sf$`Site name` != 'Lands End Alternate site',]
esites.sf$`Bay location` <- droplevels(as.factor(esites.sf$`Bay location`))

wsites.sf <- sites.sf[sites.sf$`Bay location` != 'north',]
wsites.sf$`Bay location` <- droplevels(as.factor(wsites.sf$`Bay location`))

cities <- read.csv(here('Clean_Data/CascoBay_City_Coordinates.csv'))
cities <- st_as_sf(cities, coords=c('lon', 'lat'), crs="EPSG:4326")

baylabel <- data.frame(name='Casco Bay', lon=-70.04, lat=43.67)
baylabel <- st_as_sf(baylabel, coords=c('lon', 'lat'), crs="EPSG:4326")

# Plot
westbay <- ggplot() +
  geom_sf(data=coast, fill='gray') +
  geom_sf(data=wsites.sf, cex=1.3) +
  coord_sf(xlim=c(-70.32, -70.18),
           ylim=c(43.56, 43.73)) +
  theme(axis.text.x = element_text(angle = 45, vjust=0.6)) +
  geom_sf_label_repel(data=wsites.sf, aes(label=`Site name`), force=70, seed=10) +
  labs(x=" ", y=" ") +
  geom_sf_text(data=cities[cities$name %notin% c('Freeport', 'Yarmouth'),]
               , aes(label=name), col='gray20')

eastbay <- ggplot() +
  geom_sf(data=coast, fill='gray') +
  geom_sf(data=esites.sf, cex=1.3) +
  coord_sf(xlim=c(-70.06, -69.84),
           ylim=c(43.70, 43.86)) +
  theme(axis.text.x = element_text(angle = 45, vjust=0.6)) +
  geom_sf_label_repel(data=esites.sf, aes(label=`Site name`), force=70, seed=10) +
  labs(x=" ", y=" ") +
  geom_sf_text(data=cities, aes(label=name), col='gray20')

cascobay <- ggplot() +
  geom_sf(data=coast, fill='gray') +
  coord_sf(xlim=c(-70.32, -69.84),
           ylim=c(43.56, 43.86)) +
  theme(axis.text.x = element_text(angle = 45, vjust=0.6)) +
  labs(x=" ", y=" ") +
  geom_sf_text(data=cities[cities$name != 'South Portland',], 
               aes(label=name), col='black')+
  geom_sf_text(data=baylabel,
               aes(label=name), col='navy', size=8, angle=30)

#rm(sites.sf, data.all.goodcoords, coast, date.check, i, bay_locations)
```
\newpage

### Environmental conditions
It is expected that sites within the same bay location level will have similar habitat and oceanographic qualities. We can quickly test this using our collected environmental variables -- sea surface temperature, salinity, and dissolved oxygen concentration. Sites will be ordered by increasing distance to the head of the Presumpscot River.

```{r site-check, fig.height=3.5}
trip <- data.all$trips
# Remove The Brothers - South (low sampling effort)
trip <- trip[trip$site_name != "The Brothers - South",]
trip$site_name <- as.factor(trip$site_name)
trip$site_name <- droplevels(trip$site_name)

newnames <- data.frame(
  site_name = c('Presumpscot Moorings', 'Skitterygusset', 'Audubon', 
                'Mussel Cove', 'The Brothers - North', 
                'Mackworth Island - North', 'Mackworth Island - Beach', 
                'Back Cove', 'Great Diamond Island', 'SMCC', 
                'Cushing Island', 'Alewife Cove'),
  `Site name` = c('Presumpscot', 'Skittery.', 'Audubon',
                  'Mussel C.', 'Brothers N.', 'Mack. N.', 'Mack. Beach',
                  'Back C.', 'Gr. Diamond', 'SMCC', 
                  'Cushing I.', 'Alewife C.')
)

trip <- left_join(trip, newnames, by=c('site_name'))
trip$`Bay location` <- NA
trip$`Bay location`[trip$bay_location == "Inner"] <- 'Inner'
trip$`Bay location`[trip$bay_location == "Mid"] <- 'Mid'
trip$`Bay location`[trip$bay_location == "Outer"] <- 'Outer'

trip$`Site name` <- factor(trip$Site.name,
                         levels=c('Presumpscot', 'Skittery.', 'Audubon',
                  'Mussel C.', 'Brothers N.', 'Mack. N.', 'Mack. Beach',
                  'Back C.', 'Gr. Diamond', 'SMCC', 
                  'Cushing I.', 'Alewife C.'))

ggplot(data=trip, aes(x=`Site name`, group=`Site name`)) +
  geom_boxplot(aes(y=temp_degc, col=`Bay location`)) +
  theme(axis.text.x = element_text(angle = 60, vjust = 1, hjust=1,
                                   size = 10)) +
  labs(
       x='Site',
       y='Surface temp. (C)')

ggplot(data=trip, aes(x=`Site name`, group=`Site name`)) +
  geom_boxplot(aes(y=salinity_ppt, col=`Bay location`)) +
  theme(axis.text.x = element_text(angle = 60, vjust = 1, hjust=1,
                                   size = 10)) +
  labs(
       x='Site',
       y='Salinity (ppt)')

ggplot(data=trip, aes(x=`Site name`, group=`Site name`)) +
  geom_boxplot(aes(y=`do_mg/l`, col=`Bay location`)) +
  theme(axis.text.x = element_text(angle = 60, vjust = 1, hjust=1,
                                   size = 10)) +
  labs(
       x='Site',
       y='DO (mg/L)')
```

These plots do not consider any temporal variation, but show on a broad scale that our bay location groups are fairly cohesive. There is a clear inner to outer temperature gradient, with sites inside the Presumpscot River being the warmest and those furthest from the mouth of the Presumpscot being the coldest. The inner bay sites have the lowest salinity. Middle and outer bay sites have similar salinity. Inner bay sites also have the lowest dissolved oxygen concentration; middle bay sites have slightly higher dissolved oxygen, and outer bay sites typically have the highest dissolved oxygen. 

In the future, we can run statistical tests to quantify the similarity of the sites within our groupings. For now, we'll stick with this more qualitative assessment.

\newpage

## Data exploration 
We will take the clean dataset and do some quick analysis and visualizations for the fish community structure and abundance.

### What did we catch?
This is probably the most simple question we can answer. Without looking spatial or temporal shifts, we can report having caught the following species:

```{r speciescaught, fig.pos="H"}
# Remove alewife with missing measurements

species <- as.character(unique(data.all$abundance$species_name))
species <- species[order(species)]
sum.caught <- data.frame(
  species = species,
  catch = rep(NA, length(species))
)

species.list <- split(data.all$abundance, f=data.all$abundance$species_name)
species.list <- species.list[with(species.list, order(names(species.list)))]


for(i in 1:length(species.list)){
  sum.caught$catch[i] <- sum(species.list[[i]]$catch)
}

sum.caught <- sum.caught[with(sum.caught, order(catch, decreasing = T)),]

sum.caught %>%
  kable(caption = "Fish caught 2014-2022",
        col.names = c('Species', 'Total catch'),
        row.names = FALSE) %>%
  row_spec(0, background="black", color="white") %>% 
  kable_styling(font_size = 9, latex_options = 'HOLD_position')
```

### Most-encountered species
We will calculate encounter ratio for each species we have identified-- number of encounters divided by total number of net hauls. This metric gives us more information than just total abundance OR raw number of encounters. Raw number of encounters does not account for varying sampling effort year-to-year. Total abundance does not take into account the behavioral aspect of schooling fish. We want to know what species we're most likely to pull up in the seine while accounting for these factors. 

```{r find-top8, fig.pos= 'H'}
#### Assign week/month/year ####
data.all$trips$week <- lubridate::isoweek(data.all$trips$date)
data.all$trips$month <- lubridate::month(data.all$trips$date)
data.all$trips$year <- lubridate::year(data.all$trips$date)

data.all$fish$week <- lubridate::isoweek(data.all$fish$date)
data.all$fish$month <- lubridate::month(data.all$fish$date)
data.all$fish$year <- lubridate::year(data.all$fish$date)

data.all$abundance$week <- lubridate::isoweek(data.all$abundance$date)
data.all$abundance$month <- lubridate::month(data.all$abundance$date)
data.all$abundance$year <- lubridate::year(data.all$abundance$date)

#### Call data ####
abund <- data.all$abundance
bio <- data.all$fish

#### Most often encountered fish by percentage ####
fishenc2 <- as.data.frame(table(abund$species_name))
colnames(fishenc2) <- c('species_name', 'encounter_prct')
fishenc2$encounter_prct <- fishenc2$encounter_prct /
  nrow(data.all$trips)
fishenc2$encounter_prct <- round(fishenc2$encounter_prct * 100, 1)
fishenc2 <- fishenc2[with(fishenc2, order(encounter_prct, decreasing=TRUE)),]
rownames(fishenc2) <- NULL
fishenc2 <- fishenc2[1:8,]
fishenc2 %>%
  kable(caption = "Top 8 most abundant fish by encounter percentage",
        col.names = c('Species', 'Encounter ratio')) %>%
  row_spec(0, background="black", color="white") %>% 
  kable_styling(latex_options = "HOLD_position")

#### Top 8 fish by encounter percentage ####
top8.abund <- abund[abund$species_name %in%
                      c('atlantic herring',
                        'atlantic silverside', 
                        'mummichog',
                        'alewife',
                        'sandlance',
                        'green crab',
                        'winter flounder',
                        'tomcod'),]
top8.abund$species_name <- as.factor(top8.abund$species_name)
top8.abund$species_name <- droplevels(top8.abund$species_name)

top8.bio <- bio[bio$species_name %in%
                  unique(top8.abund$species_name),]
top8.bio$species_name <- as.factor(top8.bio$species_name)
top8.bio$species_name <- droplevels(top8.bio$species_name)

rm(fishenc2)
```

\newpage

### Encounter ratios 
We will plot the encounter ratios for the 8 most-encountered species across bay location, year, month, and week of year categories. Within the levels of each category (bay location, year, etc.), the encounter ratio will be calculated as the number of times that particular species was encountered divided by the total number of samples.

```{r week-pctplot}
#### Encounter percentage per week/month/year/bay_location ####
trip <- data.all$trips

week.enc <- as.data.frame(table(top8.abund$species_name, top8.abund$week))
colnames(week.enc) <- c('species_name', 'week', 'encounter')
week.num <- as.data.frame(table(trip$week))
colnames(week.num) <- c('week', 'n_samples')
week.enc <- left_join(week.enc, week.num, by=c('week'))
week.enc$pres <- (week.enc$encounter / week.enc$n_samples)
week.enc$abs  <- 1 - week.enc$pres

ggplot(week.enc, aes(x= week,  group=species_name)) + 
    geom_bar(aes(y = pres), stat="identity") +
    labs(y = "Percent", fill="day") +
    facet_wrap(vars(species_name),
               ncol=2) +
    ylim(c(0,1)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(
       x='Week of year',
       y='Encounter ratio')
```

```{r month-pctplot}
month.enc <- as.data.frame(table(top8.abund$species_name, top8.abund$month))
colnames(month.enc) <- c('species_name', 'month', 'encounter')
month.num <- as.data.frame(table(trip$month))
colnames(month.num) <- c('month', 'n_samples')
month.enc <- left_join(month.enc, month.num, by=c('month'))
month.enc$pres <- (month.enc$encounter / month.enc$n_samples)
month.enc$abs  <- 1 - month.enc$pres

ggplot(month.enc, aes(x= month,  group=species_name)) + 
    geom_bar(aes(y = pres), stat="identity") +
    labs(y = "Percent", fill="day") +
    facet_wrap(vars(species_name),
               ncol=2) +
    ylim(c(0,1)) +
  #theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(x='Month',
       y='Encounter ratio')
```

The weekly plot is good at showcasing trends in encounter frequency with a fine-scale temporal lens, but it may suffer from unaddressed issues with uneven sampling between years and temporal autocorrelation. The monthly plot, with a slightly more coarse temporal lens, smooths issues of uneven sampling but does not account for interannual variation or temporal autocorrelation. However, these plots still showcase interesting trends in phenology, residence time, and abundance.

Most obviously, Atlantic silversides and green crabs are highly abundant. They are sampled in at least 25% of net hauls in every week of the summer sampling period. Encounter ratio for silversides has an increasing trend from early June to early September, while the encounter ratio for green crabs is fairly stable and may only show a slight increase. Mummichogs, though not as commonly encountered, may also have a slight increase in encounter ratio through the summer. Atlantic herring and tomcod show the opposite trend, with decreasing encounter frequency through the summer.

The pattern of alewife encounters may reflect the downstream migration of fish spawned the previous year. It appears as though the early June - late August period encompasses most of this movement.

Winter flounder are frequently encountered, and appear to have slightly higher encounter ratios in the mid-late summer period. 

Sandlance encounter ratios are highly variable week-to-week. It is likely that any patterns noted in their weekly or monthly encounter ratio plots are mostly driven by high interannual variability in their catch.

```{r year-pctplot}
year.enc <- as.data.frame(table(top8.abund$species_name, top8.abund$year))
colnames(year.enc) <- c('species_name', 'year', 'encounter')
year.num <- as.data.frame(table(trip$year))
colnames(year.num) <- c('year', 'n_samples')
year.enc <- left_join(year.enc, year.num, by=c('year'))
year.enc$pres <- (year.enc$encounter / year.enc$n_samples)
year.enc$abs  <- 1 - year.enc$pres

ggplot(year.enc, aes(x= year,  group=species_name)) + 
    geom_bar(aes(y = pres), stat="identity") +
    labs(y = "Percent", fill="day") +
    facet_wrap(vars(species_name),
               ncol=2) +
    ylim(c(0,1)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(y='Encounter ratio',
       x='Year') 
```

Trends in encounter ratios over the years give a quick overview of interannual variation. However, they may also reflect variable sampling effort-- note that 2018 had very low sampling effort (sampling only occurred in 3 weeks across June and July) and encounter ratios for that year may be depressed or inflated in a way that does not reflect the true abundance of species in that year.

Most species have relatively stable encounter ratios during the studied years. The exceptions are herring and sandlance, which have high encounter ratio variance, and tomcod, which have decreasing encounter ratios from 2017 to 2022.

```{r bay-pctplot}
bay_location.enc <- as.data.frame(table(top8.abund$species_name, top8.abund$bay_location))
colnames(bay_location.enc) <- c('species_name', 'bay_location', 'encounter')
bay_location.num <- as.data.frame(table(trip$bay_location))
colnames(bay_location.num) <- c('bay_location', 'n_samples')
bay_location.enc <- left_join(bay_location.enc, bay_location.num, by=c('bay_location'))
bay_location.enc$pres <- (bay_location.enc$encounter / bay_location.enc$n_samples)
bay_location.enc$abs  <- 1 - bay_location.enc$pres


ggplot(bay_location.enc, aes(x= bay_location,  group=species_name)) + 
    geom_bar(aes(y = pres), stat="identity") +
    labs(y = "Percent", fill="day") +
    facet_wrap(vars(species_name),
               ncol=2) +
    ylim(c(0,1)) +
  #theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(x='Bay location',
       y='Encounter ratio')

rm(month.enc, month.num, week.enc, week.num, year.enc, year.num,
   bay_location.enc, bay_location.num)

```

These plots illustrate likely habitat preferences of these species. Green crabs and herring may have slightly elevated encounter ratios in the middle bay region, but otherwise have very similar encounter ratios across the bay. Alewives, silversides, and mummichogs are most frequently encounter in the inner bay, with decreasing encounter ratios with increasing distance from this region. Sandlance and winter flounder have the opposite trend, with highest encounter ratios in the outer bay and lowest encounter ratios in the inner bay. Tomcod have similar encounter ratios across all regions, but may be encountered at a slightly higher rate in the outer region.

\newpage

### Abundance and residence time
We can plot the abundance of each species over the surveyed weeks for each year. This will highlight any obvious trends in residence time. We will use a raster approach, where every cell indicates the abundance of a particular species in a certain week of a year. Gray raster cells indicate that there was no catch for that species at any sampled site in that week. Clear raster cells indicate that there was no sampling conducted in that week. The remainder of the color scale indicates abundance, with low abundance being purple and high abundance being yellow. The first plot will force the same color scale across all species to also indicate relative abundance to each other. The second plot will force a unique color gradient for each species, which allows for closer examination of residence time and interannual abundance for each species. 

A few things pop out here. Atlantic silversides have been identified in every sampling week of the survey. They are one of the most-abundant organisms, as evidenced by the predominance of warmer colors in the first plot. They seem to have seasonal recruitment to the gear due to either individual growth or movement into the inshore area, with more silversides caught in the later weeks of each year. Having pulled more than my fair share of very small silversides out of the seine mesh (which acts like a gillnet when they are that size), I'm inclined to say it's probably mostly individual growth. Their abundance relative to other organisms has not changed much over the years of the survey, though 2016 and 2020 had weeks with very high abundance. 

Only one week out of all sampling did not produce at least one green crab. Green crab abundance relative to other organisms has not changed much over the years of the survey. It also has not changed much seasonally.

Winter flounder are also seen fairly often. Though they do not have any obvious seasonal or interannual trends in relative abundance, their peak abundance occurred mid-summer in 2016.

Mummichogs are caught more consistently and at higher abundances in the later weeks of the season. They have some inter-annual variation, with higher relative abundance in 2015-2016 than all other years.

Atlantic herring and tomcod have clear seasonal trends of abundance in the study area. For both species, abundance is highest in the earlier weeks of the season. Herring, which often form very large schools, have the highest single-week abundance of all 8 species, which occurred in mid-2014. Both herring and tomcod appear to leave the study area by late July.

There are no clear trends of abundance or residence time for sandlance and alewife. Both have high interannual variability and a peak abundance in mid-summer 2014.

\newpage

```{r reshape-abundance, message=F, warning=F}
#### Assign top 8 abundance to every trip ####
trip <- data.all$trips

for(i in 1:length(unique(top8.abund$species_name))){
  spec.use <- unique(top8.abund$species_name)[i]
  spec.catch <- subset(top8.abund, species_name == paste0(spec.use))
  spec.catch <- dplyr::select(spec.catch, loc_id, catch)
  colnames(spec.catch) <- c('loc_id', paste0(spec.use))
  trip <- left_join(trip, spec.catch, by=c("loc_id"))
  rm(spec.use, spec.catch)
}

# Replace NA with 0 for catch info
for(i in 1:nrow(trip)){
  for(j in 17:ncol(trip)){
    if(is.na(trip[i, j])){
      trip[i,j] <- 0
    }
  }
}

# Make another version
trip2 <- melt(trip,
  id.vars = c("date"),
  measure.vars = c("green crab", "tomcod", "winter flounder",
                   "sandlance", "mummichog", "atlantic silverside",
                   "alewife", "atlantic herring"),
  variable.name = "Species", value.name = "Abundance"
)

# Group by date and species, sum abundance
trip2 <- trip2 %>% 
  group_by(date, Species) %>% 
  summarise(catch = sum(Abundance))

trip2 <- as.data.frame(trip2)

# Add time variables
trip2$week <- lubridate::isoweek(trip2$date)
trip2$month <- lubridate::month(trip2$date)
trip2$year <- lubridate::year(trip2$date)

# 
blanks <- data.frame(
  species = unique(trip2$Species),
  week = NA,
  year = NA
)

weeks <- seq(22, 39)
years <- seq(2014, 2022)

for(i in 1:length(weeks)){
  blanks2 <- data.frame(
    species = unique(trip2$Species),
    week = rep(weeks[i], length(unique(trip2$Species))),
    year = 2014
  )
  blanks <- rbind(blanks, blanks2)
}

blanks <- blanks[complete.cases(blanks),]

for(i in 1:length(years)){
  blanks2 <- blanks
  blanks2$year <- years[i]
  
  blanks <- rbind(blanks, blanks2)
  
}

blanks <- unique(blanks)

trip2 <- dplyr::select(trip2,
                       Species, catch, week, year)
colnames(trip2)[1] <- 'species'
blanks <- left_join(blanks, trip2, by=c('species', 'week', 'year'))

rm(blanks2, trip2, i, j, weeks, years)
```

```{r, fig.width=10,fig.height=11, warning=F, message=F}
ggplot(data = blanks) +
  geom_raster(aes(y = as.factor(year), x = week, 
                  fill=log(catch + 1)
                  )) +
  facet_wrap(vars(species),
             ncol=2) +
  labs(x = 'Week of year',
       y = 'Year',
       fill= "Log abundance") +
      scale_fill_gradientn(colours = c(alpha('lightgray', 0.85), viridis::viridis(999)),
                           na.value = NA)
```

```{r abundance-notrel, fig.width=10,fig.height=11, warning=F, message=F}
p.list = lapply(sort(unique(blanks$species)), function(i) {
    ggplot(blanks[blanks$species==i,]) +
      geom_raster(aes(y=as.factor(year),
                      x=week,
                      fill=log(catch+1))) +
      facet_wrap(vars(species), ncol = 2) +
      labs(x = ' ',
           y = ' ',
           fill= "Log abundance") +
      scale_fill_gradientn(colours = c(alpha('lightgray', 0.85), viridis::viridis(999)),
                           na.value = NA,
                           n.breaks=3,
                           labels = c('Low', ' ', 'Hi'))
    

})

p.list[[1]] <- p.list[[1]] + sm_common_axis(location='topleft')
p.list[[2]] <- p.list[[2]] + sm_common_axis(location='topright')
p.list[[3]] <- p.list[[3]] + sm_common_axis(location='topleft')
p.list[[4]] <- p.list[[4]] + sm_common_axis(location='topright')
p.list[[5]] <- p.list[[5]] + sm_common_axis(location='topleft')
p.list[[6]] <- p.list[[6]] + sm_common_axis(location='topright')
p.list[[7]] <- p.list[[7]] + sm_common_axis(location='bottomleft')
p.list[[8]] <- p.list[[8]] + sm_common_axis(location='bottomright')

together2 <- plot_grid(p.list[[1]] + theme(legend.position = 'n'), p.list[[2]] + theme(legend.position = 'n'), 
                       p.list[[3]] + theme(legend.position = 'n'), p.list[[4]] + theme(legend.position = 'n'), 
                       p.list[[5]] + theme(legend.position = 'n'), p.list[[6]] + theme(legend.position = 'n'), 
                       p.list[[7]] + theme(legend.position = 'n'), p.list[[8]] + theme(legend.position = 'n'),  
          ncol = 2, 
          nrow = 4, 
          align = 'hv',
          theme(plot.margin = unit(c(0, 0, 0, 0), "cm"))) 

together2 <- together2 + theme(plot.margin = unit(c(0, 0, 1, 1), "cm")) 
together2 <- together2 + annotate("text", x=0.5, y=-0.01, label = "Week of the year", size=5.5) +
     annotate("text", x=-0.01, y=0.5, label="Year", angle=90, size=5.5)

leg <- ggpubr::get_legend(p.list[[8]])
plot_grid(together2, leg, nrow=2, rel_heights = c(1, 0.1))
```

\newpage

### Indices of abundance
This may be a foolhardy effort, but we can quickly generate some extremely basic and flawed annual indices of abundance for our 8 most-encountered species, then check out any trends. As the 2019 data is missing (but may exist), we will interpolate a linear trend between 2018 and 2020.

On these plots, the x-axis shows years of the survey and the y-axis shows catch per unit effort (number caught / number of net hauls). Points represent weekly measures of CPUE, while the blue line indicates mean CPUE and blue envelope indicates 95% confidence intervals. Please note that y-axis scales are unique to each plot. Indices for 2018 are not likely to represent true abundance trends, as most sites in this year were sampled only once or twice. 

There are a few stories here that corroborate the abundance and residence time rasters above. Tomcod have a clear decline in abundance over time. Alewives and herring may also show a slight decline. Sandlance have very high interannual variability. Winter flounder and green crab populations have not changed much over time, though winter flounder had an exceptional year in 2016. Mummichog abundance is not quite as high 2020-2022 as it was 2015-2017, but does not have a clear trend. Atlantic silversides are typically one of the most abundant fish in the surveys, have some interannual variability, but look to be at about the same abundance index level in 2022 as earlier in the time series.

```{r indices, fig.height=9}
year.abund <- dplyr::select(top8.abund,
                            year, week, species_name, catch)
year.abund <- year.abund %>% 
  group_by(species_name, year, week) %>% 
  summarise(tot.catch = sum(catch))
year.abund <- as.data.frame(year.abund)

year.eff <- dplyr::select(data.all$trips, year, week)
year.eff$year.week <- paste0(year.eff$year, "_", year.eff$week)
year.eff <- as.data.frame(table(year.eff$year.week))
colnames(year.eff) <- c('year.week', 'n_samples')
year.eff[c('year', 'week')] <- str_split_fixed(year.eff$year.week, '_', 2)
year.eff$year.week <- NULL

year.abund <- merge(year.abund, year.eff, by=c('year', 'week'))
year.abund$cpue <- year.abund$tot.catch / year.abund$n_samples

# Conf intervals
species <- sort(unique(year.abund$species_name))
species.list <- split(year.abund, f=year.abund$species_name)
species.list <- species.list[with(species.list, order(names(species.list)))]
for(i in species){
  temp.list <- species.list[names(species.list)==i]
  temp <- temp.list[[1]]
  temp <- temp %>% 
    group_by(year) %>% 
    summarise(mean.cpue = mean(cpue),
              sd = sd(cpue),
              n = sum(n_samples))
  temp$species_name <- i
  temp <- as.data.frame(temp)
  
  temp$se <- temp$sd / sqrt(temp$n)
  temp$alpha <- 0.05
  temp$df <- temp$n-1
  temp$t_score = qt(p=temp$alpha/2, df=temp$df, lower.tail=F)
  temp$me <- temp$t_score * temp$se
  temp$lowerci <- temp$mean.cpue - temp$me
  temp$upperci <- temp$mean.cpue + temp$me
  
  temp <- dplyr::select(temp, year, upperci, lowerci)
  
  species.list[[paste0(i)]] <- merge(species.list[[paste0(i)]],
                                     temp, by=c('year'))
  rm(temp, temp.list)
}
year.ci <- do.call(rbind, species.list)
rownames(year.ci) <- NULL
year.ci <- dplyr::select(year.ci, species_name, year, upperci, lowerci)
year.ci <- unique(year.ci)

year.abund <- year.abund[with(year.abund, order(year, week, species_name)),]
annual.cpue <- year.abund %>% 
  group_by(year, species_name) %>% 
  summarise(annual.cpue = mean(cpue))
annual.cpue <- as.data.frame(annual.cpue)
annual.cpue <- merge(annual.cpue, year.ci, by=c('year', 'species_name'))
#year.abund$year <- as.numeric(year.abund$year)

ggplot() +
  geom_point(data=year.abund, 
             aes(x=year, y=cpue),
             col=alpha('black', 0.4)) +
  geom_line(data=annual.cpue, 
            aes(x=year, y=annual.cpue),
            col='blue') +
  geom_ribbon(data=annual.cpue,
                aes(x=year, ymin=lowerci, ymax=upperci),
                fill=alpha('blue', 0.2)) +
  facet_wrap(vars(species_name), ncol=2, scales = 'free') +
  labs(x='Year', y='CPUE')


```


\newpage

### Size and growth
Next, we'll see if we can track growth of our most-encountered species by plotting lengths of sub-sampled individuals by week of the year.

Honestly, the resulting plots look pretty terrible. It is likely that species with no clear growth over the summer period are constantly recruiting new individuals to the gear through growth of younger individuals or constantly moving new individuals into the nearshore area. This looks to be the case for green crabs and Atlantic silversides in particular.

It's also possible that species with rapid declines in average length from early summer to mid summer are mixed cohorts-- older individuals have overwintered in the nearshore area, are immediately available to the gear in June, and then it appears as though average size drops dramatically when the young-of-year cohort recruits to the gear in July. This is almost certainly what we see for alewife in a few years.

It would be beneficial to separate cohorts during analysis, if we want to look at growth rates. As is, we are still exploring and we'll keep everything together for now.

```{r length-week, warning=F, message=F}
#### Length ####
for(i in 1:length(unique(top8.bio$species_name))){
  spec.use <- unique(top8.bio$species_name)[i]
  spec.use <- subset(top8.bio,
                     top8.bio$species_name == paste0(spec.use))
  spec.use$month <- as.factor(spec.use$month)
  
  p <- ggplot(data=spec.use) +
    geom_point(data=spec.use,
                   aes(y=length_mm, x=(week)),
               alpha=0.3) +
    facet_wrap(vars(year),
               ncol=2) +
    ggtitle(paste0(spec.use$species_name[1], 
                   ' lengths (mm)')) +
    labs(y='Length (mm)',
         x='Week of year') +
    geom_smooth(data=spec.use,
                aes(y=length_mm, x=(week)))
  
  plot(p)
  
  rm(p, spec.use)
  
}
```

\newpage

### Basic correlations
Species that have similar environment requirements/ preferences should co-occur with each other frequently, and therefore may have some interesting interactions. Because we have raw abundance of each of our top 8 species and environmental covariate data (temperature, salinity, dissolved oxygen concentration) in every net haul, we can run a simple correlation analysis to check for any obvious links between species or species and their physical environments.

The results should be taken with a grain of salt. A simple correlation analysis like this does not take spatial, temporal, or spatio-temporal autocorrelation between observations into account.

```{r correlations, eval=T}

df_cormat <- dplyr::select(trip,                         
                           temp_degc, `do_mg/l`, salinity_ppt, week, 
                           `green crab`, tomcod, `winter flounder`,
                           sandlance, mummichog, `atlantic silverside`, 
                           alewife, `atlantic herring`)
model.matrix(~0+., data=df_cormat) %>%
  cor(use="all.obs", method="spearman") %>%
  ggcorrplot::ggcorrplot(show.diag = F, type="lower", lab=TRUE, lab_size=3) + 
  labs(caption = "Figure 10: Density covariate correlation matrix")
rm(df_cormat)
```

The rule of thumb is to consider relationships with an absolute correlation value of greater than 0.3 weak, greater than 0.5 moderate, and greater than 0.7 strong. We do not have any strong correlations. The only moderate correlation is between temperature and salinity, where increasing temperature is often correlated to decreasing salinity. This is expected in the context of our study area, which includes colder saltier water in the outer bay areas and warmer fresher waters in the inner bay areas. We also notice a weak negative correlation between dissolved oxygen concentration and week of year, which indicates decreased dissolved oxygen in the later sampling period. This should also be expected.

Mummichogs and silversides have weak positive correlations to temperature. No other species have any relationship to the three environmental variables. Tomcod have a weak negative correlation to week of the year, indicating higher abundance earlier in the sampling period. Silversides have a weak positive correlation to week of the year, indicating the opposite relationship.

Two pairs of species have weak positive correlations: green crabs and winter flounder, and mummichogs and silversides. This likely indicates overlaps in habitat preferences and residence time in the inshore region.

\newpage

### Diversity indices

```{r diversity}
# Load data
trips <- data.all$trips
abund <- data.all$abundance

# Determine which species have been caught
# Create a table that shows number of net hauls in which each species was seen
#table(abund$species_name)

# Create a vector of species names which were seen at least once in CBASS seine
species <- as.character(unique(abund$species_name))

# Pull apart abundance info
abund.list <- split(abund, f=abund$loc_id)
# Should be a list of length 509-- this is the number of sites sampled in which we caught fish.

# Make blank df to copy all species abundance for each site
outer.blank <- matrix(nrow=1, ncol=(8 + length(species)))
outer.blank <- as.data.frame(outer.blank)
# Force column names to match trip information and species names
colnames(outer.blank) <- c('loc_id', 'date', 'site_name', 'site_id', 'bay_location',
                        'week', 'month', 'year', species)

# Outer loop- looking through each seine haul
for(i in 1:length(abund.list)){
  # Pull out seine haul
  temp <- abund.list[[i]]
  # Save temporary dataframe
  blank.df <- outer.blank 
  # Save static information in temporary dataframe
  blank.df$loc_id <- temp$loc_id[1]
  blank.df$date <- temp$date[1]
  blank.df$site_name <- temp$site_name[1]
  blank.df$site_id <- temp$site_id[1]
  blank.df$bay_location <- temp$bay_location[1]
  blank.df$week <- temp$week[1]
  blank.df$month <- temp$month[1]
  blank.df$year <- temp$year[1]
  
  # Inner loop- looking through each species caught (within each seine haul)
  for(j in 1:length(species)){
    # If that species was caught, copy over abundance information
    if(species[j] %in% temp$species_name){
      temp2 <- subset(temp, temp$species_name == paste0(species[j]))
      blank.df[,paste0(species[j])] <- temp2$catch
      rm(temp2)
    }
    # If that species was not caught, set abundance to 0
    if(species[j] %notin% temp$species_name){
      blank.df[,paste0(species[j])] <- 0
    }
  }
  
  # Bind altered dataframe back to list
  abund.list[[i]] <- blank.df
  # Remove temporary dataframes
  rm(temp, blank.df)
}

# Rebind to df
abund2 <- do.call(rbind, abund.list)
rownames(abund2) <- NULL

# Merge other trip information
trips <- dplyr::select(trips, loc_id, substrate, `do_mg/l`, salinity_ppt,
                       temp_degc)
abund2 <- left_join(abund2, trips, 
                    by=c('loc_id'))

# Calculate Shannon index using all species abundance information
abund2$shannon <- vegan::diversity(abund2[,9:61],
                                   index='shannon')
# Calculate Simpson index using all species abundance information
abund2$simpson <- vegan::diversity(abund2[,9:61],
                                   index='simpson')

trip <- dplyr::select(abund2,
                      site_name, bay_location,
                      week, month, year, 
                      simpson, shannon)


```

We can also examine spatial and temporal trends in common diversity indices, beginning with the Shannon index. The Shannon index is defined as $$-\sum{p_{i} * ln(p_{i})}$$ or the sum of the proportion of the entire community made up of species *i* multiplied by the natural log of the proportion of the entire community made up of species *i*. High Shannon index values indicate high biodiversity. An index value of 0 indicates that a community only has one species. The index is sensitive to rare species, and is generally better at providing quantitative measures of species richness. The Shannon index assumes random sampling and equal capture probability for all species in each net haul, which is likely a poor assumption for shore-based seines that occur in different habitats of Casco Bay. 

We'll plot the Shannon index values over the weeks, months, years, and bay locations of the survey to identify any obvious connections.

```{r shannon_index, fig.height=3.5}
#### Shannon per week/month/year/bay_location ####
ggplot(trip, aes(x= week,  group=week, y=shannon)) + 
    geom_jitter(width = 0.25, col=alpha('darkgray', 0.5)) +
    geom_boxplot(aes(y = shannon), fill=NA) +
    ylim(c(0,1)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(
       x='Week of year',
       y='Shannon index')

ggplot(trip, aes(x= month, group=month, y=shannon)) + 
    geom_jitter(width = 0.25, col=alpha('darkgray', 0.5)) + 
    geom_boxplot(aes(y = shannon), fill=NA) +
    ylim(c(0,1)) +
    xlim(c(5.5,9.5)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(
       x='Month of year',
       y='Shannon index')+
  scale_x_continuous(
  breaks = c(seq(6, 9)),
  label = c(seq(6, 9)))

ggplot(trip, aes(x= year,  group=year, y=shannon)) + 
    geom_jitter(width = 0.25, col=alpha('darkgray', 0.5)) +
    geom_boxplot(aes(y = shannon), fill=NA) +
    ylim(c(0,1)) +
    xlim(c(2013.5, 2022.5)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(
       x='Year',
       y='Shannon index') +
  scale_x_continuous(
  breaks = c(seq(2014, 2022)),
  label = c(seq(2014, 2022)))

ggplot(trip, aes(x= bay_location, group=bay_location, y=shannon)) + 
    geom_jitter(width = 0.25, col=alpha('darkgray', 0.5)) + 
    geom_boxplot(aes(y = shannon), fill=NA) +
    ylim(c(0,1)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(
       x='Bay Location',
       y='Shannon index')
```

It's difficult to find any clear trend in Shannon diversity index values within any of our possible groupings. I think if there were patterns to find in diversity, they wouldn't show up very well with the Shannon index. It's too sensitive to uncommon or rare species.

There are some notable outliers; the index value is abnormally high for week 23 and abnormally low for week 39. This is likely driven by very few samples occurring during those weeks. Median Shannon diversity index for 2020 is lower than all other years, but this may also be due to a pandemic-altered sampling schedule (all 12 sites in a week, as opposed to 6 sites in each week). There are no clear differences in diversity among the different bay locations or months.

\newpage

The second diversity index is the Simpson index. This index is defined as $$1 - \sum{p_{i}}^2$$ or 1 minus the sum of the proportion of the entire community made up of species *i* squared. The index will range between 0 and 1, with 0 indicating only one species was caught and 1 indicating high diversity. The Simpson index is not as sensitive to rare species, and does a better job of quantifying relative abundance.

We'll also plot the Simpson index values over the weeks, months, years, and bay locations of the survey.

```{r simpson_index, fig.height=3.5}
#### Simpson index per week/month/year/bay_location ####
ggplot(trip, aes(x= week,  group=week, y=simpson)) + 
      geom_jitter(width = 0.25, col=alpha('darkgray', 0.5)) + 
    geom_boxplot(aes(y = simpson), fill=NA) +
    ylim(c(0,1)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(
       x='Week of year',
       y='Simpson index')

ggplot(trip, aes(x= month,  group=month, y=simpson)) + 
      geom_jitter(width = 0.25, col=alpha('darkgray', 0.5)) +  
    geom_boxplot(aes(y = simpson), fill=NA) +
    ylim(c(0,1)) +
    xlim(c(5.5,9.5)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(
       x='Month of year',
       y='Simpson index')+
  scale_x_continuous(
  breaks = c(seq(6, 9)),
  label = c(seq(6, 9)))

ggplot(trip, aes(x= year,  group=year, y=simpson)) + 
      geom_jitter(width = 0.25, col=alpha('darkgray', 0.5)) + 
    geom_boxplot(aes(y = simpson), fill=NA) +
    ylim(c(0,1)) +
    xlim(c(2013.5, 2022.5)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(
       x='Year',
       y='Simpson index') +
  scale_x_continuous(
  breaks = c(seq(2014, 2022)),
  label = c(seq(2014, 2022)))

ggplot(trip, aes(x= bay_location,  group=bay_location, y=simpson)) + 
      geom_jitter(width = 0.25, col=alpha('darkgray', 0.5)) +  
    geom_boxplot(aes(y = simpson), fill=NA) +
    ylim(c(0,1)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  labs(
       x='Bay Location',
       y='Simpson index')
```

These plots do not indicate much of a seasonal trend in diversity, either. There may be a slight decline in diversity though the sampled weeks, but this is not reflected in the plot of diversity among months. There is notably lower diversity in later summer than early summer, though. Thinking back to our plots of abundance, this makes sense. There are several species that leave the study area mid-summer and do not return, while there are fewer species that arrive during and remain in the study area for the late summer.

Like the Shannon index plots, the Simpson plots also highlight 2020 as a year with particularly low diversity and do not indicate any difference in diversity among the bay locations.

\newpage

## Conclusions
There are some cool stories to highlight here. Just some food for thought: 
  
- Green crabs and juvenile winter flounder have ubiquitous and large populations within Casco Bay. They have similar habitat preferences and a weak correlation to each other. Their relative abundances have not changed much over time (which, in the case of winter flounder, is probably exciting for fishers).  
- If you only look at abundance indices, tomcod appear to have a declining population. This is in line with various other organizations' published information on tomcod population health. However, the residence time rasters hint that there is more to the story; they may have also shifted seasonal use of the extreme nearshore area to earlier in the summer/late spring. Tomcod are short-lived, anadromous, benthopelagic fish. They typically spend their entire lives in estuarine and neashore areas. Though as shallow-water residents they are resistant to temperature swings, they prefer colder waters. Previous studies on temperature-linked distributions of juvenile tomcod have indicated both that they used to be abundant in nearshore Maine waters into July and that they are likely to avoid areas with bottom temperatures that exceed 22$^\circ$C [(Targett & McCleave 1974)](https://digitalcommons.library.umaine.edu/cgi/viewcontent.cgi?article=1129&context=sms_facpub). Though we did not identify a correlation between tomcod abundance and surface water temperature, there is a significant difference between mean surface temperature when tomcod were present and mean surface temperature of all seine hauls. Mean water temperature for instances of tomcod capture was 1.6 degrees cooler than the mean temperature of all samples (p=0.0002, I did this test outside this document). I think it would be cool to begin surveying earlier to identify if we can identify a potential shift. I don't think we need to take bottom temperatures, as we're only seining in about 6 feet of water and there should be a tight coupling between surface and bottom temp.  
- Similarly, temperature seems to be important for herring presence. Though again, no correlation was found between temperature and abundance, t-tests indicate significant differences between mean water temperature when herring are present and mean water temperature of all seine hauls (p=0.008). Mean surface temperature when herring were captured was 0.7 degrees cooler than mean surface temperature of all seines.  
- Sandlance are important forage for many Gulf of Maine species. Their population dynamics within Casco Bay are likely impacted by myriad factors at much wider spatial scales, as reflected by the highly variable nature of the CBASS-generated indices of abundance.    
- Atlantic silversides like heat. Their abundance has a weak positive correlation to temperature, and their abundance peaked in late summer during the year with the hottest mean temperature (2020). There is a significant difference between mean surface water temperature when silversides are present and mean surface water temperature of all seine hauls; silversides were present at waters on average 0.85 degrees hotter than our mean temperature. We can expect them to do well as water temperatures continue to warm, which is good because they can serve as forage for many other piscivorous species in the region.  
